name: Deploy Telegram Bot

on:
  push:
    branches:
      - master
    paths:
       - '**.py'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 2 # To fetch the current commit and its parent (so we can compare)

    - name: Setup AWS CLI
      uses: aws-actions/configure-aws-credentials@v5
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Print changed files # To properly debug what is being deployed (It can be removed).
      run: |
        echo "List of changed files:"
        echo $(git diff --name-only HEAD^ HEAD)

    - name: build package with uv
      uses: astral-sh/setup-uv@v7

    - run: |
        uv build
        # construct env with package in it
        # TODO: FIX PACKAGE VERSION
        uv pip install dist/telegram_bot-0.1.0-py3-none-any.whl --target ./package

    - name: build package for deployment
      run: |
        # Constants
        S3_BUCKET=${{ secrets.S3_BUCKET_NAME }}
        PACKAGE_ZIP_NAME=${{ vars.PACKAGE_FILE_NAME }}
        S3_KEY=packages/$PACKAGE_ZIP_NAME
        
        cd package && zip -r ../$PACKAGE_ZIP_NAME .
        zip -q -r ../$PACKAGE_ZIP_NAME .
        # Upload the updated zip to S3
        aws s3 cp ../$PACKAGE_ZIP_NAME s3://$S3_BUCKET/$S3_KEY

    - name: deploy lambda function
      run: |
        LAMBDA_FUNCTION_NAME=${{ vars.LAMBDA_FUNCTION_NAME }}
        S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
        PACKAGE_ZIP_NAME=${{ vars.PACKAGE_FILE_NAME }}
        S3_KEY=packages/$PACKAGE_ZIP_NAME
        
        # Update Lambda function code
        aws lambda update-function-code --function-name $LAMBDA_FUNCTION_NAME --s3-bucket $S3_BUCKET_NAME --s3-key $S3_KEY

